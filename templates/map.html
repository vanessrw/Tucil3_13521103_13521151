<!DOCTYPE html>
<html>
  <head>
    <title>IF_MAP</title>
    <link rel="stylesheet" type= "text/css" href= "{{ url_for('static',filename='map.css') }}">
    <style>
        body {
            background-color: #24496E;
            <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
        }
        h1 {
            text-align: center;
            font-weight: bold;
            font-size: 40px;
            font-family: 'Poppins', sans-serif;
            color : #24496E;
            border: 3px solid #F8D669;
            -webkit-text-stroke: 2px #F8D669;
            padding: 20px;
        }
        h2 {
            text-align: center;
            font-weight: bold;
            font-size: 24px;
            font-family: 'Poppins', sans-serif;
            color : #24496E;
            -webkit-text-stroke: 2px #F8D669;
            margin-top: 10px;
        }
        button {
            background-color: #F8D669;
            font-weight: bold;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            border: none;
            border-radius: 30px;
            color: #24496E;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            margin: 6px 4px;
            cursor: pointer;
            width: 160px;
            height: 45px;
        }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
 
<script>
  var markers = [];
  var id = 1;
  var edgeMode = false;
  var nodeHoverColor = 'red';
  var nodeDefaultColor = 'green';
  var chosenNodes = [];
  var edges = [];
  var polylines = [];
  var edgeStartNode = null;

  function createPolyline(startMarker, endMarker) {
          let polyline = new google.maps.Polyline({
            path: [startMarker.getPosition(), endMarker.getPosition()],
            geodesic: true,
            strokeColor: "red",
            strokeOpacity: 1.0,
            strokeWeight: 2,
          });
          polyline.setMap(map);
          polylines.push(polyline);
  }

  function startEdgeMode() {
    edgeMode = true;
    console.log("edgeMode is now true");
    alert("Click the first node to start building an edge.");
  }
  
  function startEdgeMode() {
    edgeMode = true;
    console.log("edgeMode is now true");
    alert("Click the first node to start building an edge.");
  }
 
  function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const d = R * c; // Distance in km
    return d;
  }

  function deg2rad(deg) {
    return deg * (Math.PI/180);
  }

  let nodeCount = 0;

  function Node(position) {
    nodeCount++;
    this.id = nodeCount;
    this.position = position;
  }

  function tryMap() {
  const Latlng = { lat: -6.8915, lng: 107.6107 };
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 14,
    center: Latlng,
  });

  let edgeStartNode = null;
  let nodes = [];
  let edges = [];

  // Function to change the color of the marker when hovering
  function changeMarkerColor(marker, color) {
    marker.setIcon(`http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`);
  }

  map.addListener('click', (mapsMouseEvent) => {
    if (edgeMode) {
      // Get the ID of the clicked marker
      let clickedId = null;
      for (let i = 0; i < markers.length; i++) {
        const markerPosition = markers[i].getPosition();
        const clickPosition = mapsMouseEvent.latLng;

        // calculate distance between click position and marker position
        const distance = haversineDistance(markerPosition.lat(), markerPosition.lng(), clickPosition.lat(), clickPosition.lng());

        // if the distance is less than the click radius, select the marker
        if (distance <= 50) {
          clickedId = markers[i].getTitle();
          break;
        }
      }
      if (clickedId == null) {
        alert("Please select a valid node.");
        return;
      }

      // If this is the first node being selected, save it and prompt the user to select the second node
      if (edgeStartNode == null) {
        edgeStartNode = parseInt(clickedId);
        alert("Click the second node to complete the edge.");
      }
      // If this is the second node being selected, save the edge and exit edge mode
      else {
        let edgeEndNode = parseInt(clickedId);
        let newEdge = [edgeStartNode, edgeEndNode];
        edges.push(newEdge);
        alert("Edge added between nodes " + edgeStartNode + " and " + edgeEndNode);
        edgeMode = false;
        edgeStartNode = null;

        // Draw a polyline to represent the new edge
        createPolyline(markers.find(marker => marker.getTitle() == edgeStartNode.toString()), markers.find(marker => marker.getTitle() == edgeEndNode.toString()));
      }

    } else {
      // Add a new marker
      let marker = new google.maps.Marker({
        position: mapsMouseEvent.latLng,
        map,
        title: id,
        icon: `http://maps.google.com/mapfiles/ms/icons/${nodeDefaultColor}-dot.png`
      });

      // Change marker color when hovering
      marker.addListener('mouseover', function () {
        changeMarkerColor(marker, nodeHoverColor);
      });
      marker.addListener('mouseout', function () {
        changeMarkerColor(marker, nodeDefaultColor);
      });

      markers.push(marker);
      nodes.push(id);

      // Send the new node to the server
      const URL = '/add-node';
      const xhr = new XMLHttpRequest();
      sender = JSON.stringify([id, mapsMouseEvent.latLng]);
      xhr.open('POST', URL);
      xhr.send(sender);
      id++;
    }
  });
}

</script>


  </head>
  <body>
    <h1>
        MAP
    </h1>
    <h2>Choose Places to be Nodes</h2>
    <div id="map"></div>

    <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAODM10I674sTi_1kX905YhiM0QdzkFseY&callback=tryMap&libraries=&v=weekly"
      async
    ></script>

    <button id="add-edge-btn" 
    style="transition: opacity 0.2s;" 
    onmouseover="this.style.opacity = '0.8';" 
    onmouseout="this.style.opacity = '1';"
    onclick="startEdgeMode(); this.disabled=true;">Add Edge</button>

  </body>
</html>