<!DOCTYPE html>
<html>
  <head>
    <title>IF_MAP</title>
    <link rel="stylesheet" type= "text/css" href= "{{ url_for('static',filename='map.css') }}">
    <style>
        body {
            background-color: #24496E;
            <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
        }
        h1 {
            text-align: center;
            font-weight: bold;
            font-size: 40px;
            font-family: 'Poppins', sans-serif;
            color : #24496E;
            border: 3px solid #F8D669;
            -webkit-text-stroke: 2px #F8D669;
            padding: 20px;
        }
        h2 {
            text-align: center;
            font-weight: bold;
            font-size: 24px;
            font-family: 'Poppins', sans-serif;
            color : #24496E;
            -webkit-text-stroke: 2px #F8D669;
            margin-top: 10px;
        }
        button {
            background-color: #F8D669;
            font-weight: bold;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            border: none;
            border-radius: 30px;
            color: #24496E;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            margin: 6px 4px;
            cursor: pointer;
            width: 160px;
            height: 45px;
        }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
 
<script>
  var markers = [];
  var id = 1;
  var edgeMode = false;
  var nodeHoverColor = 'red';
  var nodeDefaultColor = 'green';
  var chosenNodes = [];
  var edges = [];
  var polylines = [];
  var edgeStartNode = null;

  function createPolyline(startMarker, endMarker) {
          let polyline = new google.maps.Polyline({
            path: [startMarker.getPosition(), endMarker.getPosition()],
            geodesic: true,
            strokeColor: "red",
            strokeOpacity: 1.0,
            strokeWeight: 2,
          });
          polyline.setMap(map);
          polylines.push(polyline);
  }


      }
      function addMarker(location) {
        // Create a marker for the clicked location
        var marker = new google.maps.Marker({
          position: location,
          map: map
        });

        markers.push(marker);

        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/add_node", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send("lat=" + location.lat() + "&lng=" + location.lng());

        // Add an event listener to the marker
        var node = markers.length - 1;
        marker.addListener('click', function(event) {
          selectNode(node);
        });
      }

      function addEdge() {
        if (!fromNode) {
          alert('Please select the starting node for the edge.');
          return;
        }
        if (!toNode) {
          alert('Please select the ending node for the edge.');
          return;
        }
        if (fromNode == toNode) {
          alert('The starting and ending nodes cannot be the same.');
          return;
        }

        // Send the new edge information to the server
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/add_edge", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhttp.send("from=" + fromNode + "&to=" + toNode);
        // Change the text on the button to "Next"
        var nextButton = document.getElementById("nextButton");
        nextButton.style.display = "block";
        var addButton = document.getElementById("addButton");
        addButton.style.display = "none";

        var edge = [fromNode, toNode];
        edges.push(edge);
        var line = new google.maps.Polyline({
          path: [markers[fromNode].getPosition(), markers[toNode].getPosition()],
          map: map,
          strokeColor: '#FF0000',
          strokeWeight: 2
        });
        fromNode = null;
        toNode = null;
      
        // Remove the click event listener from the map
        google.maps.event.removeListener(mapClickListener);
      }

      function selectNode(node) {
        if (!fromNode) {
          fromNode = node;
          alert('Please select the ending node for the edge.');
        } else if (!toNode) {
          toNode = node;
          addEdge();
        }
      }
      if (clickedId == null) {
        alert("Please select a valid node.");
        return;
      }

      // If this is the first node being selected, save it and prompt the user to select the second node
      if (edgeStartNode == null) {
        edgeStartNode = parseInt(clickedId);
        alert("Click the second node to complete the edge.");
      }
      // If this is the second node being selected, save the edge and exit edge mode
      else {
        let edgeEndNode = parseInt(clickedId);
        let newEdge = [edgeStartNode, edgeEndNode];
        edges.push(newEdge);
        alert("Edge added between nodes " + edgeStartNode + " and " + edgeEndNode);
        edgeMode = false;
        edgeStartNode = null;

        // Draw a polyline to represent the new edge
        createPolyline(markers.find(marker => marker.getTitle() == edgeStartNode.toString()), markers.find(marker => marker.getTitle() == edgeEndNode.toString()));
      }
      


</script>


  </head>
  <body>
    <h1>
        MAP
    </h1>
    <div id="map" style="height: 500px;"></div>
    <button onclick="addEdge()">Add Edge</button>
  </body>
</html>