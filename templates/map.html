<!DOCTYPE html>
<html>
  <head>
    <title>IF_MAP</title>
    <link rel="stylesheet" type= "text/css" href= "{{ url_for('static',filename='map.css') }}">
    <style>
        body {
            background-color: #24496E;
            <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
        }
        h1 {
            text-align: center;
            font-weight: bold;
            font-size: 40px;
            font-family: 'Poppins', sans-serif;
            color : #24496E;
            border: 3px solid #F8D669;
            -webkit-text-stroke: 2px #F8D669;
            padding: 20px;
        }
        h2 {
            text-align: center;
            font-weight: bold;
            font-size: 24px;
            font-family: 'Poppins', sans-serif;
            color : #24496E;
            -webkit-text-stroke: 2px #F8D669;
            margin-top: 10px;
        }
        button {
            background-color: #F8D669;
            font-weight: bold;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            border: none;
            border-radius: 30px;
            color: #24496E;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
templates/node_8.html            margin: 6px 4px;
            cursor: pointer;
            width: 160px;
            height: 45px;
        }
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
 
    <script>
        var markers = []
        var id = 1;
        var edgeMode = false;
      
        function startEdgeMode() {
          edgeMode = true;
          console.log("edgeMode is now true");
          alert("Click the first node to start building an edge.");
        }
      function tryMap() {
        const Latlng = { lat: -6.8915, lng: 107.6107 };
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: Latlng,
        });

        let edgeStartNode = null; // add this line
        let edgeEndNode = null;
        let nodes = []; // to keep track of selected nodes
        let edges = []; // to keep track of selected edges
        map.addListener("click", (mapsMouseEvent) => {
          if (edgeMode) {
            // Get the ID of the clicked marker
            let clickedId = null;
            /*for (let i = 0; i < markers.length; i++) {
                if (markers[i].getPosition().equals(mapsMouseEvent.latLng)) {
                    clickedId = markers[i].getTitle();
                    break;
                }
            }*/
            for (let i = 0; i < markers.length; i++) {
              const markerPosition = markers[i].getPosition();
              const clickPosition = mapsMouseEvent.latLng;

              // calculate distance between click position and marker position
              const distance = google.maps.geometry.spherical.computeDistanceBetween(markerPosition, clickPosition);

              // if the distance is less than the click radius, select the marker
              if (distance <= 100) {
                clickedId = markers[i].getTitle();
                break;
              }
            }
            alert(clickedId)
            if (clickedId == null) {
                alert("Please select a valid node.");
                return;
            } else {
                alert("kena");
            }
    
            // If this is the first node being selected, save it and prompt the user to select the second node
            if (edgeStartNode == null) {
                edgeStartNode = clickedId;
                alert("Click the second node to complete the edge.");
            }
            // If this is the second node being selected, save the edge and exit edge mode
            else {
                let edgeEndNode = clickedId;
                let newEdge = [edgeStartNode, edgeEndNode];
                edges.push(newEdge);
                alert("Edge added between nodes " + edgeStartNode + " and " + edgeEndNode);
                edgeMode = false;
                edgeStartNode = null;
            }
            // Add a new marker
            let marker = new google.maps.Marker({
              position: mapsMouseEvent.latLng,
              map,
              title: id.toString(),
            });
            // Change the color of the selected marker
            marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');

            markers.push(marker);

            // Send the new node to the server
            const URL = '/add-node';
            const xhr = new XMLHttpRequest();
            sender = JSON.stringify([id, mapsMouseEvent.latLng]);
            xhr.open('POST', URL);
            xhr.send(sender);
            id++;
          }
          // Add a new marker
          let marker = new google.maps.Marker({
            position: mapsMouseEvent.latLng,
            map,
            title: id.toString(),
          });
          markers.push(marker);

          // Send the new node to the server
          const URL = '/add-node';
          const xhr = new XMLHttpRequest();
          sender = JSON.stringify([id, mapsMouseEvent.latLng]);
          xhr.open('POST', URL);
          xhr.send(sender);
          id++;
        });
      }
    </script>

  </head>
  <body>
    <h1>
        MAP
    </h1>
    <h2>Choose Places to be Nodes</h2>
    <div id="map"></div>

    <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAODM10I674sTi_1kX905YhiM0QdzkFseY&callback=tryMap&libraries=&v=weekly"
      async
    ></script>

    <button id="add-edge-btn" 
        style="transition: opacity 0.2s;" 
        onmouseover="this.style.opacity = '0.8';" 
        onmouseout="this.style.opacity = '1';"
        onclick="startEdgeMode()">Add Edge</button>
  </body>
</html>